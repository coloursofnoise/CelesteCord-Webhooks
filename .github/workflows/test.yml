name: Test

on: pull_request

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Run automated tests
        run: |
          STATUS=0
          # check message length
          for message in $GITHUB_WORKSPACE/*/messages/*; do
            len=$(wc -m < $message)
            echo -e "$message\t$len"
            if (( $len < 1 )) || (( $len > 2000 )); then
              echo "::error file=$message::Length of message ($len) out of allowed bounds."
              STATUS=1
            fi
          done

          # verify embed formatting
          for embed in $GITHUB_WORKSPACE/*/embeds/*; do
            error=$(jq -ncj --slurpfile embeds $embed '{embeds:$embeds}' | \
              perl -e '$sed = q(sed -e '\''s/"/\\\"/g'\''); $json = <>; $json =~ s/<\{\{ (.+?) \}\}>/`$sed $1 | awk '{print}' ORS='\\\\\\\\\\\\\\\\n'`/ge; print $json' | \
                jq 2>&1 > /dev/null)
            if [[ ! $? ]]; then
              echo "::error file=$embed::$error"
              STATUS=1
            fi
          done

          # verify all webhooks have associated secrets
          for webhook in $GITHUB_WORKSPACE/*/; do
            webhook=$(basename "$webhook")
            if ! grep -q "$webhook" $GITHUB_WORKSPACE/.github/workflows/webhooks.yml; then
              echo "::error ::$webhook missing secret in \`webhooks.yml\`."
              STATUS=1
            fi
          done

          exit $STATUS
        shell: bash
